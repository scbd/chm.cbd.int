<script src="/app/views/management/tasks/tasks-id.html.js"></script>
<script src="/app/chm/directives/views/view-form-loader.js"></script>
<script src="/app/chm/directives/views/view-aichi-target.js"></script>
<script src="/app/chm/directives/views/view-case-study.js"></script>
<script src="/app/chm/directives/views/view-contact.js"></script>
<script src="/app/chm/directives/views/view-database.js"></script>
<script src="/app/chm/directives/views/view-implementation-activity.js"></script>
<script src="/app/chm/directives/views/view-library-resource.js"></script>
<script src="/app/chm/directives/views/view-marine-ebsa.js"></script>
<script src="/app/chm/directives/views/view-national-indicator.js"></script>
<script src="/app/chm/directives/views/view-national-report.js"></script>
<script src="/app/chm/directives/views/view-national-target.js"></script>
<script src="/app/chm/directives/views/view-organization.js"></script>
<script src="/app/chm/directives/views/view-progress-assessment.js"></script>
<script src="/app/chm/directives/views/view-resource.js"></script>
<script src="/app/chm/directives/views/view-resource-mobilisation.js"></script>
<script src="/app/chm/directives/views/view-national-support-tool.js"></script>
<script src="/app/chm/directives/views/view-strategic-plan-indicator.js"></script>

<div class="home-bottom" style="position:relative" ng-controller="TaskRequestController">
    <div class="container main" id="main" style="padding-top:6px">
      	<div class="row top">
	    	
	    	<h1>Task</h1>  
	        
			<table class="table table-striped">
			  <tr>
				  <th colspan="2">
				  	Request information and status
				  </th>	
			  </tr>	
			  <tr>
			  	<td style="width:40%">Request ID</td>
			  	<td>
			  		{{workflow._id}}
				</td>
			  </tr>
			  <tr>
			  	<td>Record ID</td>
			  	<td>
			  		<a    ng-show="workflow.result.documentID||workflow.data.documentID" ng-href="/database/record?documentID={{workflow.result.documentID||workflow.data.documentID}}">{{workflow.result.documentID||workflow.data.documentID}}</a>
			  		<span ng-hide="workflow.result.documentID||workflow.data.documentID">[new]</span>
				</td>
			  </tr>
			  <tr>
			  	<td>Summary</td>
			  	<td>
					<span ng-switch="workflow.data.metadata.schema">
						<span ng-switch-when="focalPoint">National Focal Point</span>
						<span ng-switch-when="authority">Competent National Authority</span>
						<span ng-switch-when="caseStudy">Case Study</span>
						<span ng-switch-when="contact">Contact</span>
						<span ng-switch-when="database">National Database</span>
						<span ng-switch-when="resource">Virtual Library Resource</span>
						<span ng-switch-when="organization">Organization</span>
						<span ng-switch-when="measure">National Regulation</span>
						<span ng-switch-when="marineEbsa">Ecologically or Biologically Significant Areas (EBSAs)</span>
						<span ng-switch-when="aichiTarget">Aichi Target</span>
						<span ng-switch-when="strategicPlanIndicator">Strategic Plan Indicator</span>
						<span ng-switch-when="nationalIndicator">National Indicator</span>
						<span ng-switch-when="nationalTarget">National Target</span>
						<span ng-switch-when="progressAssessment">Progress Assessment</span>
						<span ng-switch-when="nationalReport">National Report</span>
						<span ng-switch-when="implementationActivity">Implementation Activity</span>
						<span ng-switch-when="nationalSupportTool">Guidance and Support Tools</span>
						<span ng-switch-when="resourceMobilisation">Resource Mobilisation</span>
						<span ng-switch-when="absCheckpoint">Checkpoint</span>
						<span ng-switch-when="absCheckpointCommunique">Checkpoint Communiqu√©</span>
						<span ng-switch-when="absPermit">Permit</span>
						<span ng-switch-default>{{document.type}}*</span>
					</span>
					-
					<span>{{workflow.data.title | lstring}}</span>

				</td>
			  </tr>
			  <tr>
			  	<td>Requested action</td>
			  	<td>
			  		<div ng-switch="workflow.type.name">
						<span ng-switch-when="publishNationalRecord">Publish a national record</span>
						<span ng-switch-when="publishReferenceRecord">Publish a reference record</span>
						<span ng-switch-default>*{{workflow.type.name|uppercase}}</span>
					</div>
				</td>
			  </tr>
			  <tr>
			  	<td>Overall status</td>
			  	<td>
			  		<span ng-switch="workflow.state">
			  			<span ng-switch-when="running">
							<span ng-show="hasOpenActivities(workflow.activities)"><i class="glyphicon glyphicon-time"></i> Waiting for user action</span>	  				
							<span ng-hide="hasOpenActivities(workflow.activities)"><i class="glyphicon glyphicon-cog"></i> Processing</span>	  				
			  			</span>
			  			<span ng-switch-when="completed">Completed on {{workflow.closedOn|date:'yyyy-MM-dd HH:mm:ss'}}</span>
			  			<span ng-switch-when="canceled"><i class="glyphicon glyphicon-remove-circle"></i> Canceled on {{workflow.closedOn|date:'yyyy-MM-dd HH:mm:ss'}}</span>
			  			<span ng-switch-when=""><i class="glyphicon glyphicon-exclamation-sign"></i> Failed on {{workflow.closedOn|date:'yyyy-MM-dd HH:mm:ss'}}</span>
			  			<span ng-switch-default>*{{workflow.state|uppercase}}</span>
				</td>
			  </tr>
			  <tr>
			  	<th>User activity(ies)</th>
			  	<th>Status / Result</th>
			  </tr>

			  <tr ng-show="workflow.createdOn">
			  	<td>Created</td>
			  	<td>{{workflow.createdOn|date:'short'}} by {{workflow.createdBy_info.firstName}} {{workflow.createdBy_info.lastName}}</td>
			  </tr>

			  <tr ng-repeat="activity in workflow.activities">
			  	<td>
					<div ng-show="activity" ng-switch="activity.name">
						<span ng-switch-when="publishRecord">Approve or Reject record publication</span>
						<span ng-switch-default>*{{activity.name|uppercase}}</span>
					</div>
			  	</td>
			  	<td>
					<div ng-hide="activity.closedOn" ng-switch="activity.name">
						<div ng-switch-when="publishRecord">

							<span ng-hide="activity.closedOn">

								<div ng-show="isAssignedToMe(activity)">
									<button type="button" class="btn btn-primary" ng-click="updateActivity(activity.name, { action : 'approve' })"><i class="glyphicon glyphicon-ok"></i> Approve</button>
									<button type="button" class="btn btn-warning"  data-toggle="modal" data-target="#rejectModal" ng-click="$parent.$parent.currentActivity = activity" ><i class="glyphicon glyphicon-remove"></i> Reject </button>
								</div>
								<span ng-hide="isAssignedToMe(activity)">
									<i class="glyphicon glyphicon-time"></i>
									Waiting for <em>{{activity.assignedTo_info[0].firstName}} {{activity.assignedTo_info[0].lastName}}</em> to approve or reject this request.
								</span>
							</span>
							
						</div>
					</div>

					<div ng-show="activity.completedOn">

						<span ng-show="activity" ng-switch="activity.result.action">
							<span ng-switch-when="approve"><i class="glyphicon glyphicon-ok"></i> Approved</span>
							<span ng-switch-when="reject"><i class="glyphicon glyphicon-remove"></i> Rejected</span>
						</span>

						<span ng-hide="activity"><i class="glyphicon glyphicon-ok"></i> Completed</span>

						on {{activity.completedOn|date:'short'}} by {{activity.completedBy_info.firstName}} {{activity.completedBy_info.lastName}}
					</div>

					<div ng-show="activity.canceledOn">
						Canceled on {{activity.canceledOn|date:'short'}} by {{activity.canceledBy_info.firstName}} {{activity.canceledBy_info.lastName}}
					</div>

					<div ng-show="activity.failedOn">
						Failed on {{activity.failedOn|date:'short'}}
					</div>

			  	</td>
			  </tr>
			</table>

			<div ng-show="document" class="t-document">
				<div class="cbd-View-Form-Loader" document="document" hide-buttons="true" link-target="_self"></div>
			</div>	

  		</div>
	</div>


	<form name="rejectForm" role="form">
	<div class="modal fade" id="rejectModal">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	        <h4 class="modal-title">Reject a record revision</h4>
	      </div>
	      <div class="modal-body">
		    <p ng-class="{ 'has-warning':rejectForm.reason.$error.required, 'has-success':!rejectForm.reason.$invalid }">
			    <textarea class="form-control" rows="5" name="reason" ng-model="rejectReason" required></textarea>
			    <span class="help-block" ng-show="rejectForm.reason.$error.required">Please specify a reason.</span>
	        </p>
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
			<button type="button" class="btn btn-warning" data-dismiss="modal" ng-click="updateActivity(currentActivity.name, { action : 'reject', reason: rejectReason })"><i class="glyphicon glyphicon-remove"></i> Reject </button>
	      </div>
	    </div><!-- /.modal-content -->
	  </div><!-- /.modal-dialog -->
	</div><!-- /.modal -->	
    </form>


	<style>
	.t-document {
	  position: relative;
	  padding: 45px 15px 15px;
	  margin: 0 -15px 15px;
	  border-color: #e5e5e5 #eee #eee;
	  border-style: solid;
	  border-width: 1px 1px;
	}
	/* Echo out a label for the example */
	.t-document:after {
	  content: "Document to approve";
	  position: absolute;
	  top:  15px;
	  left: 15px;
	  font-size: 12px;
	  font-weight: bold;
	  color: #bbb;
	  text-transform: uppercase;
	  letter-spacing: 1px;
	}
	</style>
</div>
  